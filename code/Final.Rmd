---
title: "Final"
author: "Adam Guerra, Luke Todd, Riley Zamora"
date: "2023-06-11"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
    toc_depth: 5
    theme: sandstone
    code_folding: hide
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Loading Packages
library(tidyverse)
library(here)
library(janitor)
library(ggeffects)
library(performance)
library(naniar) 
library(flextable) 
library(car)
library(broom)
library(corrplot)
library(AICcmodavg)
library(MASS)
library(lme4)
library(MuMIn)
library(lmtest)
library(DHARMa)
library(ggeffects)
library(lmtest)
library(skimr)
library(GGally)
library(glmmTMB)
library(broom.mixed)
library(effects)
library(ggeffects)
```


## Problem 1

<br>

### Introduction

<br>

### Methods

<br>

#### Loading Data
```{r, warning = FALSE}
# loading data
kang_seed <- read.table(here("data/sev208_kratseedbank_20120213.txt"), sep=',', header = TRUE) |> 
             mutate(mnd = as.factor(mnd)) |> 
             filter(!(species %in% c("soil", "plant", "dist", "litter", "gravel")))
```

<br>

#### Missing Data
```{r}
gg_miss_var(kang_seed)
```

<br>

#### Skim
```{r}
skim(kang_seed)
```

<br>

#### Visualize Data
```{r}
# visualize counts
ggplot(kang_seed, aes(x = seeds)) +
  geom_histogram(bins = 17)

```

```{r}
#visualize using box plot
ggplot(data = kang_seed, aes(x = mnd, y = seeds)) +
  geom_boxplot() +
  labs(x = "Mound Number", y = "NUmber of Seeds", title = "Boxplot of Seeds Found at Different Mounds", 
       caption = "Figure 1: ") +
  theme_bw()
```

```{r}
# set up data for bar graph
kang_seed_bar <- kang_seed |> 
                 group_by(mnd) |> 
                 summarise(across(seeds, sum)) |> 
                 ungroup()
# bar graph
ggplot() +
  geom_bar(data = kang_seed_bar, aes(x = mnd, y = seeds, fill = mnd), 
           stat = "identity", show.legend = F) +
  theme_bw() +
  labs(x = "Mound Number", y = "Number of Seeds", 
       title = "Total Seed Count per Mound", caption = ) 
```

<br>

**Question: How does total seed number differ between kangaroo rat mound locations?**

<br>

#### Choose an Initial Test  
We will start by attempting to run an ANOVA test to determine if there is a difference in the total seed count between kangaroo rat mound locations.

<br>

#### Set Up Initial Hypothesis for ANOVA
$H_0:$ There is no significant difference in seed counts between the kangaroo rat mound locations.  
$H_a:$ There is a significant difference in seed counts between at least two of the kangaroo mound locations.

<br>

#### Initial Assumption Checks
```{r}
# make aov object
kang_aov <- aov(seeds ~ mnd, data = kang_seed)

# get resiudals
kang_res <- kang_aov$residuals

# check normality
qqPlot(kang_res)

```

The data does not appear to be normal, which we expected because in the context reading they discussed how in their analysis the data was non-normal even after trying transformations. We decided to try a log transformation regardless because this would be the logical next step in this analysis.

```{r}
# transform data
kang_seed_log <- kang_seed |> 
                 mutate(seeds = log(seeds + 1))

# make new aov object
kang_log_aov <- aov(seeds ~ mnd, data = kang_seed_log)

# residuals
kang_log_res <- kang_log_aov$residuals

#test normality
qqPlot(kang_log_res)
```

The data is still non-normal as expected (we stated above that the context paper mentioned how the data is not normal after all transformations). 

<br>

#### Kruskal-Wallis Test

Due to this we are going to run a Kruskal-Wallis test, for which we meet all assumptions (there are categorical predictor variables, there are independent samples, and each group has at least five observations) and works with count data. This will change our null and alternative hypothesis to be:  

$H_0:$ There is no difference in the median total seed number between the kangaroo rat mound locations.    
$H_a:$ There is a difference in at least two kangaroo rat mound locations median total seed number.

```{r}
# show aov summary
kruskal.test(seeds ~ mnd, data = kang_seed)
```

After running the Kruskal-Wallis test, we reject the null hypothesis. (See results).

<br>

### Results


---

## Problem 2

<br>

### Introduction

<br>

### Methods

<br>

#### Loading Data
```{r}
# loading data
shrub_raw <- read.csv(here("data/shrubstudy_seed.csv"))

shrub_seed <- shrub_raw |>
              dplyr::select(treatment, species, total_inf = total_nr_infl, 
                      num_seeds = nr_seeds, shrub_num, plant_num = plant_nr, tag_num) |>
              mutate(treatment = as.factor(treatment))
```

<br>

#### Missing Data
```{r}
# visualize missing data
gg_miss_var(shrub_seed)
```

<br>

#### Skim
```{r}
skim(shrub_seed)
```

<br>

#### Subset Dataset
```{r}
# filter out missing data
shrub_seed_sub <- shrub_seed |> 
                  drop_na(num_seeds) 
```

<br>

#### Histogram of Counts
```{r}
ggplot(shrub_seed_sub, aes(x = num_seeds)) +
  geom_histogram(bins = 17)
```

<br>

#### Histogram of Species
```{r}
ggplot(shrub_seed_sub, aes(x = species)) +
  geom_bar(stat = 'count')
```

<br>

One thing to note from this plot is that TRIDAS appears to only have one sample. Because of this, in the future, the predictions are likely to be all over the place and have a very large confidence interval. In order to increase the interpretability of the following plots, we will remove TRIDAS.

<br>

```{r}
# filter out missing data
shrub_seed_sub <- shrub_seed_sub |> 
                  subset(species != "TRIDAS")
```
    
<br>

#### Variable Relationships
```{r, warning=FALSE, message=FALSE}
shrub_seed_sub |> 
  dplyr::select(!num_seeds) |> 
  ggpairs()
```

<br>

**Question: How does seed count vary with plot type (shrub or open), plant species, and total number of inflorescences? Is there a simpler model that explains seed count, and if so, what is it?**

<br>

#### Build Models
```{r, message=FALSE, warning=FALSE}
# linear model, we know this is wrong
shrub_model1 <- lm(num_seeds ~ treatment + species + total_inf, data = shrub_seed_sub)

# generalized linear model with Poisson distribution
shrub_model2 <- glm(num_seeds ~ treatment + species + total_inf, data = shrub_seed_sub, family = "poisson")

# generalized linear model with negative binomial distribution
shrub_model3 <- glmmTMB(num_seeds ~ treatment + species + total_inf, data = shrub_seed_sub, family = "nbinom2")

# generalized linear model with Poisson distribution and random effect of treatment
shrub_model4 <- glmmTMB(num_seeds ~ treatment + species + total_inf + (1|shrub_num), 
                          data = shrub_seed_sub, family = "poisson")

# generalized linear model with negative binomial distribution and random effect of treatment
shrub_model5 <- glmmTMB(num_seeds ~ treatment + species + total_inf + (1|shrub_num), 
                      data = shrub_seed_sub, family = "nbinom2")
```

Because we are looking at count data, we know that the data is discrete and only has a lower bound. Knowing this, we built a couple different models using the Poisson and Negative Binomial distribution.

<br>

#### Model 1
```{r}
# check diagnostics
simulationOutput_m1 <- simulateResiduals(shrub_model1)

plot(simulationOutput_m1)

par(mfrow = c(1,2))

testDispersion(simulationOutput_m1)
testZeroInflation(simulationOutput_m1)
```

<br>

#### Model 2
```{r}
# check diagnostics
simulationOutput_m2 <- simulateResiduals(shrub_model2)

plot(simulationOutput_m2)

par(mfrow = c(1,2))

testDispersion(simulationOutput_m2)
testZeroInflation(simulationOutput_m2)
```

<br>

#### Model 3
```{r}
simulationOutput_m3 <- simulateResiduals(shrub_model3)

plot(simulationOutput_m3)

par(mfrow = c(1,2))

testDispersion(simulationOutput_m3)
testZeroInflation(simulationOutput_m3)
```

<br>

#### Model 4
```{r}
# check diagnostics
simulationOutput_m4 <- simulateResiduals(shrub_model4)

plot(simulationOutput_m4)

par(mfrow = c(1,2))

testDispersion(simulationOutput_m4)
testZeroInflation(simulationOutput_m4)
```

<br>

#### Model 5
```{r}
# check diagnostics
simulationOutput_m5 <- simulateResiduals(shrub_model5)

plot(simulationOutput_m5)

par(mfrow = c(1,2))

testDispersion(simulationOutput_m5)
testZeroInflation(simulationOutput_m5)
```

<br>

#### Breakdown of models 1-5:  

| Model | Formula | Distribution | QQ Plot Residuals | Residual vs. Predicted | Over/Under Dispersion | Zeros |
|---|---|---|---|---|---|---|
| shrub_model1 | num_seeds ~ treatment + species + total_inf | Normal | F | F | Under | Too many |
| shrub_model2 | num_seeds ~ treatment + species + total_inf | Poisson | F | F | Over | Too many |
| shrub_model3 | num_seeds ~ treatment + species + total_inf | Negative Binomial | P | F | None | Too many |
| shrub_model4 | num_seeds ~ treatment + species + total_inf + (1\|shrub_num) | Poisson | F | F | Over | Too many |
| shrub_model5 | num_seeds ~ treatment + species + total_inf + (1\|shrub_num) | Negative Binomial | P | F | None | Too many |

Based on the tests above, it appears that either shrub_model3 or shrub_model5 will be the best models because neither are over or under-dispered. However, they do still have some patterns in the residuals, and they appear to be zero-inflated. To further our model, we will create a new model with a zero-inflated term.


<br>

#### Model 6
```{r}
# generalized linear model with negative binomial distribution
shrub_model6 <- glmmTMB(num_seeds ~ treatment + species + total_inf, ziformula = ~1,
                        data = shrub_seed_sub, family = "nbinom2")
```

With the zero-inflated model created, we will now run the necessary diagnostics.

```{r}
# check diagnostics
simulationOutput_m6 <- simulateResiduals(shrub_model6)

plot(simulationOutput_m6)

par(mfrow = c(1,2))

testDispersion(simulationOutput_m6)
testZeroInflation(simulationOutput_m6)
```
Based on the above plots, shrub_model6 appears to be our best model. There is no over or underdispersion, and our distribution has about the same number of zeros as our model would predict. There is still some trend in our residuals, but it appears to have been lessened when compared to shrub_model3. We acknowledge this trend in residuals and have decided that isn't a big cause for concern since the other diagnostics were met.  

Moving forward, we will check AICC values to test whether our assumptions about the models are correct.

<br>

#### Which distribution to use?
```{r}
MuMIn::model.sel(shrub_model1, shrub_model2, shrub_model3, shrub_model4, shrub_model5, shrub_model6)
```

This chart confirms our assumptions about our models; shrub_model6 is best, followed by shrub_model3 and shrub_model5. We know this because of their respective AICC values of 1127.6, 1132.0, and 1133.9. In general, a lower AICC value equates to a better model.

Next, we will look closer at our model: shrub_model6.

<br>

#### Model Summary
```{r}
# summary
summary(shrub_model6)
```

The summary of our model shows that treatmentshrub, speciesCARRUP, speciesMINOBT, speciesTRIDAS, and total_inf all appears to be significant indicators of total number of seeds.

```{r, warning=FALSE, message = FALSE}
# confidence intervals
confint(shrub_model6)
```
```{r, warning = FALSE}
# adjusted R2
r.squaredGLMM(shrub_model6)
```

<br>

### Results

<br>

#### Table Format
```{r}
# model object in table
shrub_model6 |> 
  as_flextable()
```

The above displays what we studied earlier in the summary, just in an easier to digest format.

<br>

#### Visualization

<br>

```{r, warning = FALSE, message = FALSE}
# Compute predictions
predictions <- ggpredict(shrub_model6, terms = c("treatment", "species", "total_inf"))
```

```{r, warning = FALSE, message = FALSE}
# Plot showing seed differences by Species in the ACTUAL DATA
ggplot(shrub_seed_sub, aes(x = treatment, y = num_seeds, fill = treatment)) +
  geom_boxplot(aes(color = treatment), alpha = 0.5) +
  facet_wrap(~ species, scales = "free_y") +
  scale_fill_manual(values = c("control" = "lightblue", "shrub" = "salmon")) +
  scale_color_manual(values = c("control" = "lightblue", "shrub" = "salmon")) +
  theme_bw() +
  labs(
    x = "Species",
    y = "Number of Seeds",
    title = "Comparing Measured Number of Seeds per Species"
  )
```

<br>

```{r, warning = FALSE, message = FALSE}
# Predictions
pred <- ggpredict(shrub_model6, terms = "species", back.transform = TRUE)

# Plot showing seed differences by Species      
plot(pred) +
  labs(
    x = "Species",
    y = "Number of Seeds",
    title = "Comparing Estimated Number of Seeds per Species"
  )
```

<br>

```{r, warning = FALSE, message = FALSE}
ggplot(shrub_seed_sub, aes(x = treatment, y = num_seeds, fill = treatment)) +
  geom_boxplot(aes(color = treatment), alpha = 0.5) +
  scale_fill_manual(values = c("control" = "lightblue", "shrub" = "salmon")) +
  scale_color_manual(values = c("control" = "lightblue", "shrub" = "salmon")) +
  theme_bw() +
  labs(
    x = "Species",
    y = "Number of Seeds",
    title = "Comparing Measured Number of Seeds per Species"
  ) + 
  coord_cartesian(ylim = c(0, 40))
```

<br>

```{r}
# Predictions
pred2 <- ggpredict(shrub_model6, terms = "treatment", back.transform = TRUE)

# Plot showing seed differences by Species      
plot(pred2) +
  labs(
    x = "Plot Type",
    y = "Number of Seeds",
    title = "Comparing Estimated Number of Seeds per Plot Type"
  )
```

<br>

```{r}
ggplot(shrub_seed_sub, aes(x = total_inf, y = num_seeds)) +
  geom_point() +
  theme_bw() +
  labs(
    x = "Number of Inflorescences",
    y = "Number of Seeds",
    title = "Comparing Measured Number of Seeds to Number of Inflorescences"
  ) + 
  coord_cartesian(xlim = c(0, 60),
                  ylim = c(0, 500))
```

<br>

```{r}
# Predictions
pred3 <- ggpredict(shrub_model6, terms = "total_inf", back.transform = TRUE)

# Plot showing seed differences by Species      
plot(pred3) +
  labs(
    x = "Number of Inflorescences",
    y = "Number of Seeds",
    title = "Comparing Estimated Number of Seeds to Number of Inflorescences"
  ) + 
  coord_cartesian(xlim = c(0, 60),
                  ylim = c(0, 500))
```

<br>

To answer the question we are studying, **how does seed count vary with plot type (shrub or open), plant species, and total number of inflorescences**, we need to look at the effects of each of the variables. The plots above shows that the number of seeds is generally higher in the open (control) plot. Additionally, the species AREFEN tends to have the highest number of seeds, whereas CARRUP appears to have the lowest amount of seeds. Lastly, the number of seeds increases as the number of total inflorescences increases.











