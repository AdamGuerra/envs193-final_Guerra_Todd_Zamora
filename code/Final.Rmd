---
title: "Final"
author: "Adam Guerra, Luke Todd, Riley Zamora"
date: "2023-06-11"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
    toc_depth: 5
    theme: sandstone
    code_folding: hide
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Loading Packages
library(tidyverse)
library(here)
library(janitor)
library(ggeffects)
library(performance)
library(naniar) 
library(flextable) 
library(car)
library(broom)
library(corrplot)
library(AICcmodavg)
library(MASS)
library(lme4)
library(MuMIn)
library(lmtest)
library(DHARMa)
library(ggeffects)
library(lmtest)
library(skimr)
library(GGally)
library(glmmTMB)
library(broom.mixed)
library(effects)
library(ggeffects)
```


## Problem 1


### Introduction


### Methods

#### Loading Data
```{r, warning = FALSE}
# loading data
kang_seed <- read.table(here("data/sev208_kratseedbank_20120213.txt"), sep=',', header = TRUE) |> 
             mutate(mnd = as.factor(mnd)) |> 
             filter(!(species %in% c("soil", "plant", "dist", "litter", "gravel")))
```

#### Missing Data
```{r}
gg_miss_var(kang_seed)
```

#### Skim
```{r}
skim(kang_seed)
```

#### Visualize Data
```{r}
# visualize counts
ggplot(kang_seed, aes(x = seeds)) +
  geom_histogram(bins = 17)

```

```{r}
#visualize using box plot
ggplot(data = kang_seed, aes(x = mnd, y = seeds)) +
  geom_boxplot() +
  labs(x = "Mound Number", y = "NUmber of Seeds", title = "Boxplot of Seeds Found at Different Mounds") +
  theme_bw()
```

```{r}
# set up data for bar graph
kang_seed_bar <- kang_seed |> 
                 group_by(mnd) |> 
                 summarise(across(seeds, sum)) |> 
                 ungroup()
# bar graph
ggplot() +
  geom_bar(data = kang_seed_bar, aes(x = mnd, y = seeds, fill = mnd), 
           stat = "identity", show.legend = F) +
  theme_bw() +
  labs(x = "Mound Number", y = "Number of Seeds", title = "Total Seed Count per Mound") 
```

**Question: How does total seed number differ between kangaroo rat mound locations?**

#### Choose Test  
We will be performing an ANOVA test to determine if there is a difference in the total seed count between kangaroo rat mound locations.

#### Set Up Hypothesis  
$H_0:$ There is no significant difference in seed counts between the kangaroo rat mound locations.
$H_a:$ There is a significant difference in seed counts between at least two of the kangaroo mound locations.

#### Initial Assumption Checks
```{r}
# make aov object
kang_aov <- aov(seeds ~ mnd, data = kang_seed)

# get resiudals
kang_res <- kang_aov$residuals

# check normality
qqPlot(kang_res)

```

The data does not appear to be normal, which we expceted because in the context reading they discussed how in their analysis the data was non-normal even after trying transformations. We decided to try a log transformation regaudless because this would be the logical next step in this analysis.

```{r}
# transform data
kang_seed_log <- kang_seed |> 
                 mutate(seeds = log(seeds + 1))

# make new aov object
kang_log_aov <- aov(seeds ~ mnd, data = kang_seed_log)

# residuals
kang_log_res <- kang_log_aov$residuals

#test normality
qqPlot(kang_log_res)
```

The data is still non-normal as expected (we mentionded above that the context paper mentioned how the data is not normal)


```{r}
# show aov summary
summary(kang_aov)
```

The ANOVA p-value is greater than 0.05, meaning we fail to reject the null hypothesis that there is no significant difference in total seed count between different kangaroo rat mounds.

### Results



---

## Problem 2


### Introduction



### Methods


#### Loading Data
```{r}
# loading data
shrub_raw <- read.csv(here("data/shrubstudy_seed.csv"))

shrub_seed <- shrub_raw |>
              dplyr::select(treatment, species, total_inf = total_nr_infl, 
                      num_seeds = nr_seeds, shrub_num, plant_num = plant_nr, tag_num) |>
              mutate(treatment = as.factor(treatment))
```

#### Missing Data
```{r}
# visualize missing data
gg_miss_var(shrub_seed)
```

#### Skim
```{r}
skim(shrub_seed)
```

#### Subset Dataset
```{r}
# filter out missing data
shrub_seed_sub <- shrub_seed |> 
                  drop_na(num_seeds) 
```

#### Histogram of Counts
```{r}
ggplot(shrub_seed_sub, aes(x = num_seeds)) +
  geom_histogram(bins = 17)
```

#### Correlation Plot
```{r}
# calc Pearson's r for numerical values
shrub_seed_sub_cor <- shrub_seed_sub |> 
                      dplyr::select(3:4) |> 
                      cor(method = "pearson")

# plot correlation values
corrplot(shrub_seed_sub_cor,
         method = "ellipse",
         addCoef.col = "black")
```
    
#### Variable Relationships
```{r, warning=FALSE, message=FALSE}
shrub_seed_sub |> 
  dplyr::select(!num_seeds) |> 
  ggpairs()
```

**Question: How does seed count vary with plot type (shrub or open), plant species, and total number of inflorescences? Is there a simpler model that explains seed count, and if so, what is it?**


#### Build Models
```{r, message=FALSE, warning=FALSE}
# linear model, we know this is wrong
shrub_model1 <- lm(num_seeds ~ treatment + species + total_inf, data = shrub_seed_sub)

# generalized linear model with Poisson distribution
shrub_model2 <- glm(num_seeds ~ treatment + species + total_inf, data = shrub_seed_sub, family = "poisson")

# generalized linear model with negative binomial distribution
shrub_model3 <- glmmTMB(num_seeds ~ treatment + species + total_inf, data = shrub_seed_sub, family = "nbinom2")

# generalized linear model with Poisson distribution and random effect of treatment
shrub_model4 <- glmmTMB(num_seeds ~ treatment + species + total_inf + (1|shrub_num), 
                          data = shrub_seed_sub, family = "poisson")

# generalized linear model with negative binomial distribution and random effect of treatment
shrub_model5 <- glmmTMB(num_seeds ~ treatment + species + total_inf + (1|shrub_num), 
                      data = shrub_seed_sub, family = "nbinom2")
```

Because we are looking at count data, we know that the data is discrete and only has a lower bound. Knowing this, we built a couple different models using the Poisson and Negative Binomial distribution.

```{r}
# check diagnostics
simulationOutput_m1 <- simulateResiduals(shrub_model1)

plot(simulationOutput_m1)

par(mfrow = c(1,2))

testDispersion(simulationOutput_m1)
testZeroInflation(simulationOutput_m1)
```
```{r}
# check diagnostics
simulationOutput_m2 <- simulateResiduals(shrub_model2)

plot(simulationOutput_m2)

par(mfrow = c(1,2))

testDispersion(simulationOutput_m2)
testZeroInflation(simulationOutput_m2)
```
```{r}
simulationOutput_m3 <- simulateResiduals(shrub_model3)

plot(simulationOutput_m3)

par(mfrow = c(1,2))

testDispersion(simulationOutput_m3)
testZeroInflation(simulationOutput_m3)
```
```{r}
# check diagnostics
simulationOutput_m4 <- simulateResiduals(shrub_model4)

plot(simulationOutput_m4)

par(mfrow = c(1,2))

testDispersion(simulationOutput_m4)
testZeroInflation(simulationOutput_m4)
```
```{r}
# check diagnostics
simulationOutput_m5 <- simulateResiduals(shrub_model5)

plot(simulationOutput_m5)

par(mfrow = c(1,2))

testDispersion(simulationOutput_m5)
testZeroInflation(simulationOutput_m5)
```

Breakdown of models 1-5:  
| Model | Formula | Distribution | QQ Plot Residuals | Residual vs. Predicted | Over/Under Dispersion | Zeros |
|---|---|---|---|---|---|---|
| shrub_model1 | num_seeds ~ treatment + species + total_inf | Normal | F | F | Under | Too many |
| shrub_model2 | num_seeds ~ treatment + species + total_inf | Poisson | F | F | Over | Too many |
| shrub_model3 | num_seeds ~ treatment + species + total_inf | Negative Binomial | P | F | None | Too many |
| shrub_model4 | num_seeds ~ treatment + species + total_inf + (1\|shrub_num) | Poisson | F | F | Over | Too many |
| shrub_model5 | num_seeds ~ treatment + species + total_inf + (1\|shrub_num) | Negative Binomial | P | F | None | Too many |

Based on the tests above, it appears that either shrub_model3 or shrub_model5 will be the best models because neither are over or under-dispered. However, they do still have some patterns in the residuals, and they appear to be zero-inflated. To further our model, we will create a new model with a zero-inflated term.

```{r}
# generalized linear model with negative binomial distribution
shrub_model6 <- glmmTMB(num_seeds ~ treatment + species + total_inf, ziformula = ~1,
                        data = shrub_seed_sub, family = "nbinom2")
```

With the zero-inflated model created, we will now run the necessary diagnostics.

```{r}
# check diagnostics
simulationOutput_m6 <- simulateResiduals(shrub_model6)

plot(simulationOutput_m6)

par(mfrow = c(1,2))

testDispersion(simulationOutput_m6)
testZeroInflation(simulationOutput_m6)
```
Based on the above plots, shrub_model6 appears to be our best model. There is no over or underdispersion, and our distribution has about the same number of zeros as our model would predict. There is still some trend in our residuals, but it appears to have been lessened when compared to shrub_model3. We acknowledge this trend in residuals and have decided that isn't a big cause for concern since the other diagnostics were met.  

Moving forward, we will check AICC values to test whether our assumptions about the models are correct.


#### Which distribution to use?
```{r}
MuMIn::model.sel(shrub_model1, shrub_model2, shrub_model3, shrub_model4, shrub_model5, shrub_model6)
```

This chart confirms our assumptions about our models; shrub_model6 is best, followed by shrub_model3 and shrub_model5. We know this because of their respective AICC values of 1127.6, 1132.0, and 1133.9. In general, a lower AICC value equates to a better model.

Next, we will look closer at our model: shrub_model6.

#### Model Summary
```{r}
# summary
summary(shrub_model6)
```

The summary of our model shows that treatmentshrub, speciesCARRUP, speciesMINOBT, speciesTRIDAS, and total_inf all appears to be significant indicators of total number of seeds.

```{r, warning=FALSE, message = FALSE}
# confidence intervals
confint(shrub_model6)
```
```{r, warning = FALSE}
# adjusted R2
r.squaredGLMM(shrub_model6)
```


### Results

#### Table Format
```{r}
# model object in table
shrub_model6 |> 
  as_flextable()
```

The above displays what we studied earlier in the summary, just in an easier to digest format.

#### Visualization
```{r, message = FALSE, warning = FALSE}
plot(allEffects(shrub_model6))
```

To answer the question we are studying, **how does seed count vary with plot type (shrub or open), plant species, and total number of inflorescences**, we need to look at the effects of each of the variables. This plot shows that the number of seeds is generally higher in the open (control) plot. Additionally, the species TRIDAS tends to have the highest number of seeds, whereas CARRUP appears to have the lowest amount of seeds. Lastly, the number of seeds increases as the number of total inflorescenses increases.